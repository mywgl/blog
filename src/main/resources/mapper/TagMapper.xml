<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.blog.dao.TagDao">
    <insert id="saveTag" parameterType="Tag" useGeneratedKeys="true" keyProperty="id">
        insert into t_tag(name) value (#{name});
    </insert>

    <select id="getTagById" parameterType="Long" resultType="Tag">
        select *
        from t_tag
        where id = #{id};
    </select>

    <update id="updateTag" parameterType="Tag">
        update t_tag
        set name=#{name}
        where id = #{id}
    </update>

    <delete id="deleteById" parameterType="Long">
        delete
        from t_tag
        where id = #{id}
    </delete>


    <select id="getAllTag" resultType="tag">
        select *
        from t_tag
    </select>

    <select id="getTagByName" resultType="Tag">
        select *
        from t_tag
        where name = #{name}
    </select>

    <select id="listTagByIds" parameterType="Long" resultType="Tag">
        select *
        from t_tag
        where
         <foreach collection="list" index="index" item="item" open=" id in (" separator="," close=")">
             #{item}
         </foreach>
    </select>

    <!--根据删除的tagId 删除中间表某些关联数据-->
    <delete id="deleteCenterTabByTagId">
        delete
        from t_blog_tag
        where tag_id = #{tagId}
    </delete>

    <resultMap id="tag" type="Tag">
        <id property="id" column="tt_id"/>
        <result property="name" column="tt_name"/>
        <collection property="blogs" ofType="Blog">
            <id property="id" column="id"/>
        </collection>
    </resultMap>

    <select id="getTagTop" parameterType="_int" resultMap="tag">
        select tt.id tt_id, tt.name tt_name, tb.*
        from  t_blog_tag tbt
                  left join t_blog tb on tbt.blog_id = tb.id
                  left join t_tag tt on tbt.tag_id = tt.id
                ,
              (select tag_id, count(1) c
               from t_blog_tag tbt
                        left join t_blog tb on tbt.blog_id = tb.id
                        left join t_tag tt on tbt.tag_id = tt.id
               group by tt.name ,tt.id
               limit #{pagSize}
              )t
        where t.tag_id = tbt.tag_id
        order by  c desc
    </select>
</mapper>